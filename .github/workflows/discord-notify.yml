name: Discord Push Notification

on:
  push:
    branches: [main]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get commit info
        id: commit
        run: |
          # Get title (first line)
          echo "title=$(git log -1 --pretty=%s)" >> $GITHUB_OUTPUT

          # Get body and convert bullet points to numbered list
          echo "body<<EOF" >> $GITHUB_OUTPUT
          git log -1 --pretty=%b | grep -E '^- ' | nl -w1 -s'. ' | sed 's/^//' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "sha=$(git log -1 --pretty=%h)" >> $GITHUB_OUTPUT
          echo "files=$(git diff --name-only HEAD~1 HEAD | head -10 | tr '\n' ', ' | sed 's/,$//')" >> $GITHUB_OUTPUT
          STATS=$(git diff --shortstat HEAD~1 HEAD | sed 's/ files\? changed//' | sed 's/ insertions\?(+)/+/' | sed 's/ deletions\?(-)/âˆ’/' | tr -d ' ')
          echo "stats=${STATS:-no changes}" >> $GITHUB_OUTPUT

      - name: Send Discord notification
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # Escape special characters for JSON
          TITLE=$(echo '${{ steps.commit.outputs.title }}' | sed 's/"/\\"/g' | head -c 200)
          # Remove bullet prefix, escape quotes, and convert newlines to \n for JSON
          BODY=$(echo '${{ steps.commit.outputs.body }}' | sed 's/- //g' | sed 's/"/\\"/g' | awk '{printf "%s\\n", $0}' | sed 's/\\n$//')
          FILES=$(echo '${{ steps.commit.outputs.files }}' | sed 's/"/\\"/g')

          # Build description with title and numbered body in code block
          if [ -n "$BODY" ]; then
            DESC="**$TITLE**\n\n\`\`\`\n$BODY\`\`\`"
          else
            DESC="**$TITLE**"
          fi

          curl -H "Content-Type: application/json" -X POST "$WEBHOOK_URL" -d "{
            \"embeds\": [{
              \"title\": \"OthmanBot - Code Update\",
              \"description\": \"$DESC\",
              \"color\": 5814783,
              \"fields\": [
                {
                  \"name\": \"Files Changed\",
                  \"value\": \"\`$FILES\`\",
                  \"inline\": false
                },
                {
                  \"name\": \"Commit\",
                  \"value\": \"[\`${{ steps.commit.outputs.sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})\",
                  \"inline\": true
                },
                {
                  \"name\": \"Author\",
                  \"value\": \"${{ steps.commit.outputs.author }}\",
                  \"inline\": true
                },
                {
                  \"name\": \"Changes\",
                  \"value\": \"\`${{ steps.commit.outputs.stats }}\`\",
                  \"inline\": true
                },
                {
                  \"name\": \"Compare\",
                  \"value\": \"[View Diff](https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }})\",
                  \"inline\": true
                }
              ],
              \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
              \"thumbnail\": {
                \"url\": \"https://cdn-icons-png.flaticon.com/512/25/25231.png\"
              }
            }]
          }"
